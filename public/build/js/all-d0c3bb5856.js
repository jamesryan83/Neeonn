"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t}),function(e,t){"use strict";var i={_positionClasses:["bottom-left","bottom-right","top-right","top-left","bottom-center","top-center","mid-center"],_defaultIcons:["success","error","info","warning"],init:function(t){this.prepareOptions(t,e.toast.options),this.process()},prepareOptions:function(t,i){var a={};"string"==typeof t||t instanceof Array?a.text=t:a=t,this.options=e.extend({},i,a)},process:function(){this.setup(),this.addToDom(),this.position(),this.bindToast(),this.animate()},setup:function(){var t="";if(this._toastEl=this._toastEl||e("<div></div>",{"class":"jq-toast-single"}),t+='<span class="jq-toast-loader"></span>',this.options.allowToastClose&&(t+='<span class="close-jq-toast-single">&times;</span>'),this.options.text instanceof Array){this.options.heading&&(t+='<h2 class="jq-toast-heading">'+this.options.heading+"</h2>"),t+='<ul class="jq-toast-ul">';for(var i=0;i<this.options.text.length;i++)t+='<li class="jq-toast-li" id="jq-toast-item-'+i+'">'+this.options.text[i]+"</li>";t+="</ul>"}else this.options.heading&&(t+='<h2 class="jq-toast-heading">'+this.options.heading+"</h2>"),t+=this.options.text;this._toastEl.html(t),this.options.bgColor!==!1&&this._toastEl.css("background-color",this.options.bgColor),this.options.textColor!==!1&&this._toastEl.css("color",this.options.textColor),this.options.textAlign&&this._toastEl.css("text-align",this.options.textAlign),this.options.icon!==!1&&(this._toastEl.addClass("jq-has-icon"),-1!==e.inArray(this.options.icon,this._defaultIcons)&&this._toastEl.addClass("jq-icon-"+this.options.icon))},position:function(){"string"==typeof this.options.position&&-1!==e.inArray(this.options.position,this._positionClasses)?"bottom-center"===this.options.position?this._container.css({left:e(t).outerWidth()/2-this._container.outerWidth()/2,bottom:20}):"top-center"===this.options.position?this._container.css({left:e(t).outerWidth()/2-this._container.outerWidth()/2,top:20}):"mid-center"===this.options.position?this._container.css({left:e(t).outerWidth()/2-this._container.outerWidth()/2,top:e(t).outerHeight()/2-this._container.outerHeight()/2}):this._container.addClass(this.options.position):"object"==typeof this.options.position?this._container.css({top:this.options.position.top?this.options.position.top:"auto",bottom:this.options.position.bottom?this.options.position.bottom:"auto",left:this.options.position.left?this.options.position.left:"auto",right:this.options.position.right?this.options.position.right:"auto"}):this._container.addClass("bottom-left")},bindToast:function(){var e=this;this._toastEl.on("afterShown",function(){e.processLoader()}),this._toastEl.find(".close-jq-toast-single").on("click",function(t){t.preventDefault(),"fade"===e.options.showHideTransition?(e._toastEl.trigger("beforeHide"),e._toastEl.fadeOut(function(){e._toastEl.trigger("afterHidden")})):"slide"===e.options.showHideTransition?(e._toastEl.trigger("beforeHide"),e._toastEl.slideUp(function(){e._toastEl.trigger("afterHidden")})):(e._toastEl.trigger("beforeHide"),e._toastEl.hide(function(){e._toastEl.trigger("afterHidden")}))}),"function"==typeof this.options.beforeShow&&this._toastEl.on("beforeShow",function(){e.options.beforeShow()}),"function"==typeof this.options.afterShown&&this._toastEl.on("afterShown",function(){e.options.afterShown()}),"function"==typeof this.options.beforeHide&&this._toastEl.on("beforeHide",function(){e.options.beforeHide()}),"function"==typeof this.options.afterHidden&&this._toastEl.on("afterHidden",function(){e.options.afterHidden()})},addToDom:function(){var t=e(".jq-toast-wrap");if(0===t.length?(t=e("<div></div>",{"class":"jq-toast-wrap"}),e("body").append(t)):(!this.options.stack||isNaN(parseInt(this.options.stack,10)))&&t.empty(),t.find(".jq-toast-single:hidden").remove(),t.append(this._toastEl),this.options.stack&&!isNaN(parseInt(this.options.stack),10)){var i=t.find(".jq-toast-single").length,a=i-this.options.stack;a>0&&e(".jq-toast-wrap").find(".jq-toast-single").slice(0,a).remove()}this._container=t},canAutoHide:function(){return this.options.hideAfter!==!1&&!isNaN(parseInt(this.options.hideAfter,10))},processLoader:function(){if(!this.canAutoHide()||this.options.loader===!1)return!1;var e=this._toastEl.find(".jq-toast-loader"),t=(this.options.hideAfter-400)/1e3+"s",i=this.options.loaderBg,a=e.attr("style")||"";a=a.substring(0,a.indexOf("-webkit-transition")),a+="-webkit-transition: width "+t+" ease-in;                       -o-transition: width "+t+" ease-in;                       transition: width "+t+" ease-in;                       background-color: "+i+";",e.attr("style",a).addClass("jq-toast-loaded")},animate:function(){var e=this;if(this._toastEl.hide(),this._toastEl.trigger("beforeShow"),"fade"===this.options.showHideTransition.toLowerCase()?this._toastEl.fadeIn(200,function(){e._toastEl.trigger("afterShown")}):"slide"===this.options.showHideTransition.toLowerCase()?this._toastEl.slideDown(function(){e._toastEl.trigger("afterShown")}):this._toastEl.show(function(){e._toastEl.trigger("afterShown")}),this.canAutoHide()){var e=this;t.setTimeout(function(){"fade"===e.options.showHideTransition.toLowerCase()?(e._toastEl.trigger("beforeHide"),e._toastEl.fadeOut(200,function(){e._toastEl.trigger("afterHidden")})):"slide"===e.options.showHideTransition.toLowerCase()?(e._toastEl.trigger("beforeHide"),e._toastEl.slideUp(function(){e._toastEl.trigger("afterHidden")})):(e._toastEl.trigger("beforeHide"),e._toastEl.hide(function(){e._toastEl.trigger("afterHidden")}))},this.options.hideAfter)}},reset:function(t){"all"===t?e(".jq-toast-wrap").remove():this._toastEl.remove()},update:function(e){this.prepareOptions(e,this.options),this.setup(),this.bindToast()}};e.toast=function(e){var t=Object.create(i);return t.init(e,this),{reset:function(e){t.reset(e)},update:function(e){t.update(e)}}},e.toast.options={text:"",heading:"",showHideTransition:"fade",allowToastClose:!0,hideAfter:3e3,loader:!0,loaderBg:"#9EC600",stack:5,position:"bottom-left",bgColor:!1,textColor:!1,textAlign:"left",icon:!1,beforeShow:function(){},afterShown:function(){},beforeHide:function(){},afterHidden:function(){}}}(jQuery,window,document);var app=app||{};app.data={},app.data.serverHost="http://shoteratetest.azurewebsites.net",app.data.categories=["Uncategorized","Action","Adventure","Adult","Animals","Apparel","Art","Articles","Autobiography","Beauty","Biography","Bizzare","Business","Cars","Children","Computers","Design","Education","Electronics","Entertainment","Fantasy","Film","Finance","Fitness","Food","Funny","Games","General","Health","History","Home and Garden","Horror","Internet","Journals","Music","Mystery","News","Outdoors","Pets","Photography","Poetry","Politics","Real Estate","Religion","Restaurants","Romance","Science","Science Fiction","Social","Space","Spirituality","Sports","Technology","Television","Travel","Tutorial","Video Games","Weddings","Writing"],app.data.patternImages=["60-lines.png","asfalt-dark.png","black-linen.png","black-paper.png","brick-wall.png","concrete-wall-3.png","cubes.png","dark-denim.png","dark-leather.png","dark-matter.png","dark-wood.png","diagmonds-light.png","flowers.png","foggy-birds.png","food.png","gray-floral.png","inflicted.png","inspiration-geometry.png"],app.data.emojiImages=["1f197.png","1f308.png","1f332.png","1f334.png","1f335.png","1f349.png","1f34d.png","1f352.png","1f354.png","1f355.png","1f357.png","1f367.png","1f36d.png","1f378.png","1f3a8.png","1f3a9.png","1f3b5.png","1f433.png","1f444.png","1f44d-1f3fb.png","1f453.png","1f48e.png","1f49c.png","1f49e.png","1f4a3.png","1f4a5.png","1f4aa-1f3fc.png","1f4b0.png","1f4f1.png","1f4f7.png","1f50d.png","1f525.png","1f52b.png","1f5e1.png","1f600.png","1f601.png","1f602.png","1f603.png","1f604.png","1f605.png","1f606.png","1f607.png","1f608.png","1f609.png","1f610.png","1f611.png","1f612.png","1f613.png","1f614.png","1f615.png","1f616.png","1f617.png","1f618.png","1f619.png","1f620.png","1f621.png","1f622.png","1f623.png","1f624.png","1f625.png","1f626.png","1f627.png","1f628.png","1f629.png","1f630.png","1f631.png","1f632.png","1f633.png","1f634.png","1f636.png","1f637.png","1f638.png","1f642.png","1f644.png","1f680.png","1f6e0.png","1f6e9.png","26a0.png","26c5.png","2b50.png"],app.data.searchSortBy=["Latest","Oldest"],app.data.sceneHeight=290,app.data.sceneWidth=580,app.data.sceneWidthHalf=290,app.data.colorNeonPink="#ff4081",app.data.colorGrayMedium2="#838383",app.data.colorComment1="#eaeaea",app.data.colorComment2="#d3d3d3",app.data.colorBlack="#000000",app.data.regexHashtag=/(^|\s)(#[\w]+)/gi,app.data.regexUrl=/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/gi,app.data.regexImageProxy=/http:\/\/shoteratetest.azurewebsites.net\/image-proxy/g;var app=app||{};app.util={},app.util.getFilenameFromImageUrl=function(e){var t=e.split("/");return t[t.length-1]},app.util.stringStartsWithHttpOrHttps=function(e){return app.util.stringStartsWith(e,"http://")===!1&&app.util.stringStartsWith(e,"https://")===!1?(app.util.showToast("Error","Url must start with http:// or https://"),!1):!0},app.util.stringEndsWithImageExtension=function(e){return e=e.toLowerCase(),app.util.stringEndsWith(e,".jpg")===!1&&app.util.stringEndsWith(e,".jpeg")===!1&&app.util.stringEndsWith(e,".png")===!1&&app.util.stringEndsWith(e,".gif")===!1?(app.util.showToast("Error","Url must end with .jpg, .jpeg, .png or.gif"),!1):!0},app.util.stringStartsWith=function(e,t){return 0===e.indexOf(t)},app.util.stringEndsWith=function(e,t){var i=e.length-t.length;return i>=0&&e.lastIndexOf(t)===i},app.util.preventWindowScroll=function(e){e.on("mousewheel",function(e){var t=e.originalEvent,i=t.wheelDelta||-t.detail;this.scrollTop+=30*(0>i?1:-1),e.preventDefault()})},app.util.sortArray=function(e,t){return e.sort(function(e,i){var a=e[t],n=i[t];return n>a?-1:a>n?1:0})},app.util.sortIntegerArray=function(e,t){return e.sort(function(e,i){return e[t]-i[t]})},app.util.showToast=function(e,t){$.toast({text:t,heading:e,allowToastClose:!1,hideAfter:3e3,stack:5,position:"bottom-right",bgColor:"#333333",textColor:"#ff2f77",textAlign:"center",loader:!1})},app.util.hideDialog=function(){$("#divDialogContainer").hide(),$("#divDialogContainer").empty(),$("#divDialogContainer").unbind()},app.util.scrollDivToBottom=function(e){$(e).scrollTop($(e)[0].scrollHeight)},app.util.placeCaretAtEnd=function(e){if(e.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var i=window.getSelection();i.removeAllRanges(),i.addRange(t)}else if("undefined"!=typeof document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}};var app=app||{};app.server={},app.server.getGalleryImages=function(e){app.server.ajaxRequest("GET","/get-gallery-images",null,"Error getting gallery images",e)},app.server.getImageFromUrl=function(e,t){app.server.ajaxRequest("POST","/upload-image-url",{url:e},"Error getting image from url",t)},app.server.getStoryboardsForImage=function(e,t){app.server.ajaxRequest("POST","/get-storyboards-for-image",{imageName:e},"Error getting storyboards for image",t)},app.server.deleteImage=function(e,t){app.server.ajaxRequest("POST","/delete-image",{imageName:e},"Error deleting image",t)},app.server.updateGalleryOrder=function(e,t){app.server.ajaxRequest("POST","/update-gallery-order",{data:e},"Error updating gallery order",t)},app.server.getStoryboard=function(e,t){app.server.ajaxRequest("GET","/get-storyboard",{storyboard_id:e},"Error getting Storyboard",t)},app.server.getAllStoryboards=function(e){app.server.ajaxRequest("GET","/get-all-storyboards",null,"Error getting Storyboards",e)},app.server.createStoryboard=function(e,t){app.server.ajaxRequest("POST","/create-storyboard",{data:e},"Error creating Storyboard",t)},app.server.updateStoryboardDetails=function(e,t){app.server.ajaxRequest("POST","/update-storyboard-details",{data:e},"Error saving Storyboard details",t)},app.server.deleteStoryboard=function(e,t){app.server.ajaxRequest("POST","/delete-storyboard",{storyboard_id:e},"Error deleting Storyboard",t)},app.server.createScene=function(e,t){app.server.ajaxRequest("POST","/create-scene",{data:e},"Error creating Scene",t)},app.server.updateSceneCanvas=function(e,t){app.server.ajaxRequest("POST","/update-scene-canvas",{data:e},"Error updating Scene canvas",t)},app.server.updateSceneText=function(e,t){app.server.ajaxRequest("POST","/update-scene-text",{data:e},"Error updating Scene text",t)},app.server.updateSceneIndicies=function(e,t){app.server.ajaxRequest("POST","/update-scene-indicies",{data:e},"Error updating Scene order",t)},app.server.deleteScene=function(e,t){app.server.ajaxRequest("POST","/delete-scene",{data:e},"Error deleting Scene",t)},app.server.getComments=function(e,t){app.server.ajaxRequest("GET","/get-comments",{storyboard_id:e},"Error getting Comments",t)},app.server.makeComment=function(e,t){app.server.ajaxRequest("POST","/make-comment",{data:e},"Error making Comment",t)},app.server.updateComment=function(e,t){app.server.ajaxRequest("POST","/update-comment",{data:e},"Error updating Comment",t)},app.server.voteOnComment=function(e,t){app.server.ajaxRequest("POST","/vote-on-comment",{data:e},"Error voting on Comment",t)},app.server.deleteComment=function(e,t){app.server.ajaxRequest("POST","/delete-comment",{data:e},"Error deleting Comment",t)},app.server.changePassword=function(e,t){app.server.ajaxRequest("POST","/account/change-password",{data:e},"Error changing password",t)},app.server.updateAccount=function(e,t,i){app.server.ajaxRequest("POST",e,{data:t},"Error updating account",i)},app.server.search=function(e,t){app.server.ajaxRequest("POST","/search",{data:e},"Error searching",t)},app.server.ajaxRequest=function(e,t,i,a,n){$.ajax({type:e,url:t,data:i,success:function(e){e.success===!0?n(!0,e.data):(app.util.showToast("Error",e.message),n(!1,e))},error:function(e){app.util.showToast("Error",a),n(!1,a)}})};var app=app||{};app.main=app.main||{},app.main.view=app.main.view||{},app.main.view.Main=Backbone.View.extend({el:"#divContentApp",events:{"click #divGoToTop":"scrollToTop"},initialize:function(){$(document).scroll(function(){$(document).scrollTop()>200?$("#divGoToTop").show():$("#divGoToTop").hide()})},scrollToTop:function(){var e=!1;$("html, body").animate({scrollTop:"0"},{complete:function(){e===!1&&(e=!0)}})}});var app=app||{};app.items=app.items||{},app.items.view=app.items.view||{},app.items.view.StoryboardItem=Backbone.View.extend({className:"divStoryboardSceneItemFullContainer",template:_.template($("#templateStoryboardSceneItemFull").html()),events:{"click .divButtonComment":"comment","click .divButtonStar":"star","click .divButtonShare":"share","click .divButtonExpand":"fullScreen","click .divButtonEdit":"edit","click .divButtonDelete":"delete","click .divNavNext":"nextScene","click .divNavPrevious":"previousScene","click .divContentArea":"fullScreen"},initialize:function(e,t){this.page=e,this.data=t,this.selectedIndex=0,this.render()},render:function(){return"account"!==this.page&&"Uncategorized"===this.data.category&&(this.data.category=" "),this.$el.html(this.template({storyboard_id:this.data.storyboard_id,title:this.data.title,category:this.data.category,username:this.data.username,num_comments:this.data.num_comments})),this.$el.find(".divInner").css({"background-color":this.data.scene_color}),void 0!==self.scene_pattern&&null!==self.scene_pattern&&0!==self.scene_pattern.length&&this.$el.find(".divInner").css({"background-image":"url(../res/patterns/"+this.data.scene_pattern+")"}),app.util.preventWindowScroll(this.$el.find(".divActualText")),void 0!==this.data.scenes&&this.data.scenes.length>0&&(this.data.scenes=app.util.sortIntegerArray(this.data.scenes,"storyboard_index"),this.setSelectedScene(),this.data.scenes.length<=1&&(this.$el.find(".divNavPrevious").hide(),this.$el.find(".divNavNext").hide())),"search"===this.page||"user"===this.page||"comments"===this.page?(this.$el.find(".divIconPrivate").hide(),this.$el.find(".divButtonEdit").hide(),this.$el.find(".divButtonDelete").hide(),this.$el.find(".divButtonExpand").css({"margin-right":0})):"1"===this.data.is_private&&this.$el.find(".divIconPrivate").css({display:"inline-block"}),"comments"===this.page&&(this.$el.find(".divCommentNumber").hide(),this.$el.find(".divButtonComment").hide()),"0"===this.data.allow_comments&&(this.$el.find(".divButtonComment").hide(),this.$el.find(".divCommentNumber").hide()),this},setSelectedScene:function(){this.$el.find(".labelCurrentScene").text(this.selectedIndex+1+"/"+this.data.scenes.length),this.$el.find(".divPicture").empty(),this.$el.find(".divActualText").empty(),this.$el.find(".divPicture").unbind(),this.$el.find(".divActualText").unbind();var e=this.data.scenes[this.selectedIndex].text;if(null!==e&&e.length>0){var t=e.replace(app.data.regexHashtag,"<a class='aSceneHashtag'>$&</a>");t=t.replace(app.data.regexUrl,"<a class='aSceneUrl'>$&</a>"),this.$el.find(".divActualText").append(t)}var i=this.data.scenes[this.selectedIndex].canvas_data_svg;null!==i&&i.length>0&&("search"!==this.page&&"user"!==this.page&&"comments"!==this.page||(i=i.replace(/image-proxy/g,"image-proxy-public/"+this.data.user_id)),this.$el.find(".divPicture").append($(i)));var a=this.data.scenes[this.selectedIndex].type;switch(a){case"canvastext":this.$el.find(".divPicture").css({display:"block","float":"left",width:"50%",height:app.data.sceneHeight}),this.$el.find(".divText").css({display:"block","float":"right",width:"50%",height:app.data.sceneHeight});break;case"textcanvas":this.$el.find(".divPicture").css({display:"block","float":"right",width:"50%",height:app.data.sceneHeight}),this.$el.find(".divText").css({display:"block","float":"left",width:"50%",height:app.data.sceneHeight});break;case"canvas":this.$el.find(".divText").css({display:"none"}),this.$el.find(".divPicture").css({display:"block",width:"100%",height:app.data.sceneHeight});break;case"text":this.$el.find(".divPicture").css({display:"none"}),this.$el.find(".divText").css({display:"block",width:"100%",height:app.data.sceneHeight})}this.$el.find(".divActualText").scrollTop(0)},nextScene:function(){this.selectedIndex<this.data.scenes.length-1&&(this.selectedIndex+=1,this.setSelectedScene())},previousScene:function(){this.selectedIndex>0&&(this.selectedIndex-=1,this.setSelectedScene(this.selectedIndex))},comment:function(){var e=this.$el.find(".divStoryboardSceneItemFull").data("storyboard_id");location.href="/comments/"+e},star:function(){},share:function(){},fullScreen:function(){$("#divDialogContainer").show(),new app.dialog.view.StoryboardFullScreen(this.data,function(e){app.util.hideDialog()})},edit:function(){if("account"===this.page){var e=this.$el.find(".divStoryboardSceneItemFull").data("storyboard_id");location.href="/edit-storyboard/"+e}},"delete":function(){if("account"===this.page){var e=this,t=this.$el.find(".divStoryboardSceneItemFull").data("storyboard_id"),i={heading:"Delete Storyboard",text1:"Are you sure you want to delete this Storyboard ?",text2:"Its Scenes will also be deleted and it cannot be undone"};$("#divDialogContainer").show(),new app.dialog.view.OkCancel(i,function(i){app.util.hideDialog(),i===!0&&app.server.deleteStoryboard(t,function(t,i){t===!0&&app.account.view.storyboards.deleteStoryboard(e)})})}}});var app=app||{};app.items=app.items||{},app.items.view=app.items.view||{},app.items.view.SceneItem=Backbone.View.extend({className:"divStoryboardSceneItem",template:_.template($("#templateStoryboardSceneItemBasic").html()),events:{"click .divMoveUpButton":"moveUp","click .divMoveDownButton":"moveDown","click .divDeleteSceneButton":"deleteScene","click .divTextContainer":"focusTextArea","click .divActualText":"startCkEditor","click .canvasMain":"canvasClicked","focusin .divActualText":"startSaveText","focusout .divActualText":"endSaveText","focusin .divCanvasContainer":"startSaveCanvas","focusout .divCanvasContainer":"endSaveCanvas","click .divCanvasButtonSelect":function(){this.canvasAction("select")},"click .divCanvasButtonSketch":function(){this.canvasAction("sketch")},"click .divCanvasButtonText":function(){this.canvasAction("text")},"click .divCanvasButtonPicture":function(){this.canvasAction("picture")},"click .divCanvasButtonEmoji":function(){this.canvasAction("emoji")},"click .divCanvasButtonClear":function(){this.canvasAction("clear")},"change .selectPathThickness":"setPathThickness"},initialize:function(e){var t=this;this.scene_id=e.scene_id,this.data=e,this.canvasSelectedColor="#000000",this.textSelectedColor="#000000",this.canvasIsRedoing=!1,this.canvasItems=[],this.lastText=e.text,this.lastCanvas=e.canvas_data_json,this.image_name=null,this.debugSaveOff=!1,this.render(),setTimeout(function(){"canvastext"!==t.data.type&&"textcanvas"!==t.data.type&&"canvas"!==t.data.type||(t.canvas=new fabric.Canvas("canvas"+t.data.storyboard_index),t.canvas.selection=!0,t.canvas.freeDrawingBrush.width=5,t.canvas.freeDrawingBrush.color=app.data.colorNeonPink,t.image_name=app.data.image_name,void 0===t.image_name&&(t.image_name=null),document.getElementById("canvas"+t.data.storyboard_index).fabric=t.canvas,t.canvas.on("object:added",function(e){e.target.set({borderColor:app.data.colorNeonPink,cornerColor:app.data.colorNeonPink,cornerSize:8,padding:3,rotatingPointOffset:20,hoverCursor:"pointer",transparentCorners:!1}),t.canvasIsRedoing===!1&&(t.canvasItems=[]),t.canvasIsRedoing=!1}),t.data.canvas_data_json&&t.data.canvas_data_json.length>0&&t.canvas.loadFromJSON(t.data.canvas_data_json,t.canvas.renderAll.bind(t.canvas)),t.$el.find(".divCanvasContainer").keydown(function(e){46===e.keyCode?t.canvasAction("delete"):e.ctrlKey&&89==e.keyCode?t.canvasAction("redo"):e.ctrlKey&&90==e.keyCode?t.canvasAction("undo"):38==e.keyCode?(e.preventDefault(),t.canvasAction("moveUp")):40==e.keyCode&&(e.preventDefault(),t.canvasAction("undo"),t.canvasAction("moveDown"))}),$("#inputCanvasColorPicker"+t.data.storyboard_index).spectrum({showPalette:!0,showAlpha:!0,color:t.canvasSelectedColor,clickoutFiresChange:!1,show:function(){$("body > .sp-container").find(".sp-choose").on("click.myChooseClick",function(){t.updateSelectedCanvasColor($("#inputCanvasColorPicker"+t.data.storyboard_index).spectrum("get").toHexString())})},hide:function(){$("body > .sp-container").find(".sp-choose").off("click.myChooseClick")}})),"canvastext"!==t.data.type&&"textcanvas"!==t.data.type&&"text"!==t.data.type||$("#inputTextColorPicker"+t.data.storyboard_index).spectrum({showPalette:!0,showAlpha:!0,color:t.textSelectedColor,clickoutFiresChange:!1,show:function(){$("body > .sp-container").find(".sp-choose").on("click.myChooseClick",function(){t.updateSelectedTextColor($("#inputTextColorPicker"+t.data.storyboard_index).spectrum("get").toHexString())})},hide:function(){$("body > .sp-container").find(".sp-choose").off("click.myChooseClick")}})},0)},render:function(){switch(this.$el.html(this.template({scene_id:this.data.scene_id,type:this.data.type,storyboard_index:this.data.storyboard_index})),this.data.type){case"canvastext":case"textcanvas":this.$el.find("canvas").attr("width",app.data.sceneWidthHalf),this.$el.find("canvas").attr("height",app.data.sceneHeight),this.$el.find(".divActualText").css({"max-width":app.data.sceneWidthHalf});break;case"text":this.$el.find(".divCanvas").hide(),this.$el.find(".divActualText").css({"max-width":app.data.sceneWidth});break;case"canvas":this.$el.find(".divText").hide(),this.$el.find("canvas").attr("width",app.data.sceneWidth),this.$el.find("canvas").attr("height",app.data.sceneHeight)}return this.$el.find(".divInner > div").addClass("divType_"+this.data.type),void 0!==this.data&&"canvas"!==this.data.type&&this.$el.find(".divActualText").append(this.data.text),this.$el.find(".divCanvasControls").hide(),app.util.preventWindowScroll(this.$el.find(".divActualText")),this},moveUp:function(){app.editStoryboard.view.main.moveSceneUp(this.$el)},moveDown:function(){app.editStoryboard.view.main.moveSceneDown(this.$el)},deleteScene:function(){var e=this,t={heading:"Delete Scene",text1:"Are you sure you want to delete this Scene ?",text2:""};$("#divDialogContainer").show(),new app.dialog.view.OkCancel(t,function(t){app.util.hideDialog(),t===!0&&app.editStoryboard.view.main.removeScene(e)})},canvasClicked:function(){this.$el.find(".divTextControls").hide(),this.$el.find(".divActualText").attr("contenteditable",!1),app.editStoryboard.view.main.removeEditorInstances(),app.editStoryboard.view.main.hideCanvasControls(),this.$el.find(".divCanvasControls").show()},setPathThickness:function(){this.canvas.freeDrawingBrush.width=this.$el.find(".selectPathThickness").val()},updateSelectedCanvasColor:function(e){this.canvasSelectedColor=e,this.canvas.freeDrawingBrush.color=e;var t=this.canvas.getActiveObject();void 0!==t&&null!==t&&(null===t.fill?t.set("stroke",e):t.set("fill",e),this.canvas.renderAll())},addPictureToCanvas:function(){var e=this;$("#divDialogContainer").show(),new app.dialog.view.CanvasChoosePicture(function(t,i){app.util.hideDialog(),t===!0&&("addBackgroundPicture"===i?($("#divGalleryContainer").show(),new app.dialog.view.PictureGallery(function(t,i){if($("#divGalleryContainer").hide(),$("#divGalleryContainer").empty(),$("#divGalleryContainer").unbind(),t===!0){var a="canvas"===e.data.type;$("#divDialogContainer").show(),new app.dialog.view.PositionBackgroundImage(a,i,function(t,a){app.util.hideDialog(),t===!0&&fabric.Image.fromURL("/image-proxy/"+i,function(t){e.canvas.setBackgroundImage(t,e.canvas.renderAll.bind(e.canvas),{left:a.left,top:a.top,width:a.width,height:a.height,backgroundImageStretch:!1}),e.image_name=i,e.saveCanvasData()})})}})):"addBackgroundColor"===i?(e.canvas.backgroundColor=e.canvasSelectedColor,e.canvas.renderAll(),e.saveCanvasData()):"removeBackground"===i&&(e.canvas.backgroundColor=null,e.canvas.backgroundImage=null,e.canvas.renderAll(),e.image_name=null,e.saveCanvasData()))})},clearCanvas:function(){var e=this,t={heading:"Clear Canvas",text1:"Are you sure you want to clear the canvas ?",text2:"It cannot be undone"};$("#divDialogContainer").show(),new app.dialog.view.OkCancel(t,function(t){app.util.hideDialog(),t===!0&&(e.canvas.clear(),e.canvas.backgroundColor=null,e.canvas.backgroundImage=null,e.canvas.renderAll())})},canvasAction:function(e){var t=this;"delete"!==e&&(this.canvas.isDrawingMode=!1);var i=this.canvas.getActiveObject(),a=null;switch(e){case"select":return;case"sketch":this.canvas.isDrawingMode=!0;break;case"text":a=new fabric.IText("Text",{fontSize:20,fill:this.canvasSelectedColor});break;case"picture":this.addPictureToCanvas();break;case"emoji":$("#divGalleryContainer").show(),new app.dialog.view.Emoji(function(e,i){$("#divGalleryContainer").hide(),$("#divGalleryContainer").empty(),$("#divGalleryContainer").unbind(),e===!0&&fabric.Image.fromURL(i,function(e){e.scaleToWidth(30),e.set("left",100),e.set("top",100),t.canvas.add(e),t.saveCanvasData()})});break;case"moveDown":void 0!==i&&null!==i&&i.sendBackwards();break;case"moveUp":void 0!==i&&null!==i&&i.bringForward();break;case"delete":void 0!==i&&null!==i&&this.canvas.remove(i);break;case"clear":this.clearCanvas();break;case"undo":this.canvas._objects.length>0&&(this.canvasItems.push(this.canvas._objects.pop()),this.canvas.renderAll());break;case"redo":this.canvasItems.length>0&&(this.canvasIsRedoing=!0,this.canvas.add(this.canvasItems.pop()))}void 0!==a&&null!==a&&this.canvas.add(a)},startSaveCanvas:function(){if(this.debugSaveOff!==!0){var e=this;this.saveCanvasTimer=setInterval(function(){var t=JSON.stringify(e.canvas);t!==e.lastCanvas&&e.saveCanvasData(),e.lastCanvas=t},2e3)}},endSaveCanvas:function(){if(this.debugSaveOff!==!0){clearInterval(this.saveCanvasTimer);var e=JSON.stringify(this.canvas);e!==this.lastCanvas&&this.saveCanvasData(),this.lastCanvas=e}},saveCanvasData:function(){app.server.updateSceneCanvas({scene_id:this.scene_id,image_name:this.image_name,canvas_data_json:JSON.stringify(this.canvas),canvas_data_svg:this.canvas.toSVG({suppressPreamble:!0,width:"canvas"===this.data.type?app.data.sceneWidth:app.data.sceneWidthHalf,height:app.data.sceneHeight,viewBox:{x:0,y:0,width:"canvas"===this.data.type?app.data.sceneWidth:app.data.sceneWidthHalf,height:app.data.sceneHeight}})},function(e){})},focusTextArea:function(e){$(".divActualText").is(":focus")===!1&&(this.$el.find(".divActualText").focus(),this.startCkEditor())},startCkEditor:function(){var e=this,t=this.$el.find(".divActualText").attr("id");if(app.editStoryboard.view.main.hideCanvasControls(),!(t in CKEDITOR.instances)){app.editStoryboard.view.main.removeEditorInstances(),e.$el.find(".divActualText").attr("contenteditable",!0),CKEDITOR.disableAutoInline=!0;var i=CKEDITOR.inline(t,{removePlugins:"floatingspace,maximize,resize",sharedSpaces:{top:this.$el.find(".editorTop").attr("id"),bottom:this.$el.find(".editorBottom").attr("id")}});i.on("instanceReady",function(t){e.$el.find(".divTextControls").css({display:"inline-block"}),app.util.placeCaretAtEnd(e.$el.find(".divActualText")[0]),i.on("afterPaste",function(e){var t=i.getData().replace(/&nbsp;/g," ");t=t.replace(/<p><\/p>/,""),i.editable().setHtml(t)})})}},updateSelectedTextColor:function(e){this.textSelectedColor=e;var t=this.$el.find(".divStoryboardSceneItemBasic").data("storyboard_index"),i=CKEDITOR.instances["editor"+t];0!==i.getSelection().getSelectedText().trim().length&&i.applyStyle(new CKEDITOR.style({element:"span",attributes:{style:"color: "+e}}))},startSaveText:function(){if(this.debugSaveOff!==!0){var e=this;this.saveTextTimer=setInterval(function(){var t=e.$el.find(".divActualText").html();t!==e.lastText&&app.server.updateSceneText({scene_id:e.scene_id,text:t},function(e){}),e.lastText=t},2e4)}},endSaveText:function(){if(this.debugSaveOff!==!0){clearInterval(this.saveTextTimer);var e=this.$el.find(".divActualText").html();e!==this.lastText&&app.server.updateSceneText({scene_id:this.scene_id,text:e},function(e){}),this.lastText=e}}});var app=app||{};app.base=app.base||{},app.base.view=app.base.view||{},app.base.view.GalleryBase=Backbone.View.extend({events:{"click #buttonFromUrl":"showFromUrlDialog","click .divItemImage":"imageClicked","click .divGalleryIconDelete":"checkDeleteImage"},initialize:function(){var e=this;this.showGallery(),this.appendGalleryLoadingItem(),app.server.getGalleryImages(function(t,i){if(e.removeGalleryLoadingItem(),t===!0)if(0===i.images.length)e.hideGallery();else{e.showGallery();for(var a=0;a<i.images.length;a++)e.appendGalleryItem(i.images[a]);var n=document.getElementById("divPictures"),o=new Sortable(n,{animation:150,onSort:function(e){var t=o.toArray().join("|");app.server.updateGalleryOrder(t,function(e){})}});if(null!==i.order&&i.order.length>0){var s=i.order.split("|");s.length>1&&o.sort(s)}}}),this.setupGetImageFromComputer()},showFromUrlDialog:function(){var e=this;$("#divDialogContainer").show(),new app.dialog.view.FromUrl("#divDialogContainer",function(t,i){app.util.hideDialog(),t===!0&&(0===$("#divPictures").children().length&&e.showGallery(),e.appendGalleryLoadingItem(),app.server.getImageFromUrl(i,function(t,i){e.removeGalleryLoadingItem(),t===!0&&e.appendGalleryItem(i)}))})},setupGetImageFromComputer:function(){var e=this;this.$el.find(".fileupload").fileupload({dataType:"json",maxNumberOfFiles:1,acceptFileTypes:/^image\/(gif|jpe?g|png)$/i,maxFileSize:1e6,add:function(e,t){var i=$(this),a=t.process(function(){return i.fileupload("process",t)});a.done(function(){t.submit()}),a.fail(function(e){app.util.showToast("Error",e.files[0].error)})},beforeSend:function(){0==$("#divPictures").children().length&&e.showGallery(),e.appendGalleryLoadingItem()},done:function(t,i){e.removeGalleryLoadingItem(),i.result&&i.result.success===!0?e.appendGalleryItem(i.result.data):app.util.showToast("Error","Error uploading image");
},fail:function(e,t){app.util.showToast("Error","Unknown server error")}})},imageClicked:function(e){var t=$(e.target).closest(".divGalleryItem").find("img")[0].src.replace("thumb_","");$("#divDialogContainer").show(),new app.dialog.view.ViewPicture(t,function(){app.util.hideDialog()})},checkDeleteImage:function(e){var t=this,i=$(e.target).data("imgname");app.server.getStoryboardsForImage(i,function(i,a){i===!0&&(a.linked===!1?t.deleteImage(e):a.titles.length>0?($("#divDialogContainer").show(),new app.dialog.view.ImageStoryboardLink(a.titles,function(i){app.util.hideDialog(),i===!0&&t.deleteImage(e)})):t.deleteImage(e))})},deleteImage:function(e){var t=this,i=$(e.target).closest(".divGalleryItem"),a=$(e.target).data("imgname");app.server.deleteImage(a,function(e,a){e===!0&&($(i).remove(),0==$("#divPictures").children().length&&t.hideGallery())})},appendGalleryItem:function(e){var t=e.filename.replace("thumb_",""),i="<div class='divGalleryItem' data-id='"+e.filename+"'><div class='divItemButtons'><div class='divGalleryIconDelete' data-imgname='"+t+"' title='Delete'></div><div class='clearfix'></div></div><div class='divItemImage'><img class='imgItem center' src='"+e.url_thumb+"?"+(new Date).getTime()+"' /></div></div>";this.$el.find("#divPictures").prepend($(i))},appendGalleryLoadingItem:function(e,t){var i=$("<div class='divGalleryItem loadingItem'><div class='divItemImage'><img class='imgItem center' src='../res/loading_hourglass2.svg' height=40 width=40  /></div></div>");e===!0?$(t).replaceWith(i):this.$el.find("#divPictures").prepend(i)},removeGalleryLoadingItem:function(){this.$el.find(".loadingItem").remove()},showGallery:function(){$("#divGalleryImagesContainer").empty(),$("#divGalleryImagesContainer").unbind(),$("#divGalleryImagesContainer").append($("<div id='divPictures'></div>"))},hideGallery:function(){$("#divGalleryImagesContainer").empty(),$("#divGalleryImagesContainer").unbind();var e="<div id='divNoImages'><p>You have no images !</p><p>Click <b>Add From Url</b> or <b>Add From Computer</b> to add some</p></div>";$("#divGalleryImagesContainer").append($(e))}});var app=app||{};app.account=app.account||{},app.account.view=app.account.view||{},app.account.view.Storyboards=Backbone.View.extend({el:"#divContentStoryboards",events:{"click #buttonCreateStoryboard":"createStoryboard"},initialize:function(){var e=this;this.hideStoryboards(),$("#divLoadingStoryboards").show(),app.server.getAllStoryboards(function(t,i){if(t===!0)if($("#divLoadingStoryboards").hide(),0===i.length)e.hideStoryboards();else{e.showStoryboards();for(var a=0;a<i.length;a++)e.appendStoryboardItem(i[a])}})},createStoryboard:function(){$("#divDialogContainer").show(),new app.dialog.view.CreateStoryboard(function(e,t){return e===!1?void app.util.hideDialog():void app.server.createStoryboard(t,function(e,t){app.util.hideDialog(),e===!0&&(location.href="/edit-storyboard/"+t)})})},appendStoryboardItem:function(e){this.showStoryboards();var t=new app.items.view.StoryboardItem("account",e);$("#divStoryboards").prepend(t.el)},deleteStoryboard:function(e){e.remove(),0==$("#divStoryboards").children().length&&this.hideStoryboards()},showStoryboards:function(){$("#divStoryboards").show(),$("#divNoStoryboards").hide()},hideStoryboards:function(){$("#divStoryboards").hide(),$("#divNoStoryboards").show()}});var app=app||{};app.account=app.account||{},app.account.view=app.account.view||{},app.account.view.Gallery=app.base.view.GalleryBase.extend({el:"#divContentGallery"});var app=app||{};app.account=app.account||{},app.account.view=app.account.view||{},app.account.view.Settings=Backbone.View.extend({el:"#divContentSettings",events:{"click #buttonSettingsSave":function(){this.updateAccount("save")},"click #buttonSettingsDisable":function(){this.updateAccount("disable")},"click #buttonSettingsEnable":function(){this.updateAccount("enable")},"click #buttonSettingsDelete":function(){this.deleteAccount()}},updateAccount:function(e){$("#pErrors").text("");var t,i=null;switch(e){case"save":t="/update-account",i={fullname:$("#inputAccountSettingsFullName").val(),username:$("#inputAccountSettingsUsername").val(),email:$("#inputAccountSettingsEmail").val(),website:$("#inputAccountSettingsWebsite").val(),location:$("#inputAccountSettingsLocation").val(),summary:$("#inputAccountSettingsSummary").val()};break;case"disable":t="/disable-account";break;case"enable":t="/enable-account";break;case"delete":t="/delete-account"}app.server.updateAccount(t,i,function(e,t){e===!0&&(app.util.showToast("Success","Settings Saved"),setTimeout(function(){location.reload()},1e3))})},deleteAccount:function(){var e=this,t={heading:"Delete Account",text1:"Are you sure you want to delete your account ?",text2:"You will lose all your content and it cannot be undone"};$("#divDialogContainer").show(),new app.dialog.view.OkCancel(t,function(t){app.util.hideDialog(),t===!0&&e.updateAccount("delete")})}});var app=app||{};app.account=app.account||{},app.account.view=app.account.view||{},app.account.view.ChangePassword=Backbone.View.extend({el:"#divAccountChangePassword",events:{"click #buttonChangePassword":"changePassword","click #buttonReturn":"return"},changePassword:function(){var e={oldPassword:$("#inputChangePasswordOld").val(),newPassword:$("#inputChangePasswordNew").val(),newPassword_confirmation:$("#inputChangePasswordNewConfirmation").val()};app.server.changePassword(e,function(e,t){e===!0&&app.util.showToast("Success","Password Successfully Changed")})},"return":function(){location.href="/account/settings"}});var app=app||{};app.comments={},app.comments.view={},app.comments.view.Main=Backbone.View.extend({el:"#divComments",events:{},initialize:function(){var e=this;this.storyboard_id=this.$el.data("storyboard_id"),app.server.getStoryboard(this.storyboard_id,function(e,t){$("#divLoading").hide(),e===!0&&$("#divStoryboard").append(new app.items.view.StoryboardItem("comments",t).el)}),app.server.getComments(this.storyboard_id,function(t,i){if($("#divLoading").hide(),t===!0){var a=0,n=e.$el.find("#divCommentsList");for(a=0;a<i.comments.length;a++){var o=new app.comments.view.CommentItem(i.comments[a]);void 0!==i.comments[a].is_deleted&&1==i.comments[a].is_deleted?o.isDeleted():void 0!==i.user_id&&i.user_id==i.comments[a].user_id&&o.showEditAndDelete(),0==i.comments[a].parent_id?$(n).append(o.el):$(n).find("[data-comment_id='"+i.comments[a].parent_id+"']").find(".divCommentChild").first().append(o.el)}if(void 0!==i.votes)for(a=0;a<i.votes.length;a++){var s=null;"u"===i.votes[a].direction?s="divButtonUpvote":"d"===i.votes[a].direction&&(s="divButtonDownvote");$(n).find("[data-comment_id='"+i.votes[a].comment_id+"']").find("."+s).first().addClass(s+"Highlight")}e.colorComments(),e.updateCommentsLabel()}});var t=new app.comments.view.CommentInputs(null,!0,!1).el;$("#divCommentInputsMain").append(t),$("#textareaComment").on("input selectionchange propertychange",function(){$("#labelNumCharacters").text($(this).val().length+"/3000")})},colorComments:function(){var e=[];if($("#divCommentsList").find(".divCommentItem").each(function(){e.push({element:this,level:$(this).parents().length})}),e.length>0){e=app.util.sortIntegerArray(e,"level");for(var t=!0,i=1;i<e.length;i++)e[i].level!==e[i-1].level&&(t=!t),$(e[i].element).css({"background-color":t?app.data.colorComment1:app.data.colorComment2});$("time.timeago").timeago()}},updateCommentsLabel:function(){var e=this.$el.find(".divCommentItem").length;1===e?$("#labelNumComments").text("1 Comment"):$("#labelNumComments").text(e+" Comments")}}),app.comments.view.CommentInputs=Backbone.View.extend({className:"divCommentInputsContainer",template:_.template($("#templateCommentInputs").html()),events:{"click .buttonSaveComment":"saveComment","click .buttonCancelComment":"cancelComment"},initialize:function(e,t,i,a){this.item=e,this.isMainCommentInput=t,this.isEdit=i,this.editData=a,this.render()},render:function(){return this.$el.html(this.template()),this.isMainCommentInput===!0&&this.$el.find(".buttonCancelComment").hide(),this.isEdit===!0&&this.$el.find(".textareaComment").first().val(this.editData.text),this},saveComment:function(){var e=this,t=this.$el.find(".textareaComment").val();if(0===t.length)return void app.util.showToast("You need to enter some text");if(t.length>3e3)return void app.util.showToast("Comment limit is 1000 characters");if(this.isEdit===!0){var i={comment_id:this.editData.comment_id,text:t};app.server.updateComment(i,function(a,n){$("#divCommentsList").find("[data-comment_id='"+i.comment_id+"']").find(".divCommentItemText").first().text(t);e.cancelComment()})}else{var a=this.$el.closest(".divCommentItem").data("comment_id");void 0===a&&(a=0);var i={storyboard_id:app.comments.view.main.storyboard_id,text:t,parent_id:a};app.server.makeComment(i,function(t,a){if(t===!0){i.comment_id=a.comment_id,i.username=a.username,i.updated_at=a.updated_at.date,i.points=1;var n=new app.comments.view.CommentItem(i);null===e.item?$("#divCommentsList").prepend(n.el):$(e.item).find(".divCommentChild").first().prepend(n.el),n.setUpvote(),n.showEditAndDelete(),e.isMainCommentInput||e.cancelComment(),app.comments.view.main.colorComments(),app.comments.view.main.updateCommentsLabel()}})}},cancelComment:function(){this.$el.remove()}}),app.comments.view.CommentItem=Backbone.View.extend({className:"divCommentItemContainer",template:_.template($("#templateCommentItem").html()),events:{"click .divButtonUpvote":"clickedUpvote","click .divButtonDownvote":"clickedDownvote","click .aCommentItemUsername":"goToUserPage","click .aCommentItemReply":"replyToComment","click .aCommentItemEdit":"editComment","click .aCommentItemDelete":"deleteComment"},initialize:function(e){this.data=e,this.render()},render:function(){return this.$el.html(this.template({comment_id:this.data.comment_id,user_id:this.data.user_id,username:this.data.username,points:this.data.points,updated_at:this.data.updated_at.replace(" ","T")+"-02:00",text:this.data.text})),this},goToUserPage:function(){},replyToComment:function(){this.showInput(!1)},editComment:function(){this.showInput(!0,{comment_id:this.data.comment_id,text:this.$el.find(".divCommentItemText").first().html()})},deleteComment:function(){var e=this,t={comment_id:this.data.comment_id};app.server.deleteComment(t,function(t){t===!0&&e.isDeleted()})},showInput:function(e,t){var i=this.$el.find(".divCommentChild").first(),a=$(i).find(".divCommentInputsContainer").first();if(0===a.length){var n=new app.comments.view.CommentInputs(this.$el,!1,e,t).el;$(i).prepend(n)}else $(a).show()},showEditAndDelete:function(){this.$el.find(".divCommentItemEdit").first().css({display:"inline-block"}),this.$el.find(".divCommentItemDelete").first().css({display:"inline-block"})},isDeleted:function(){this.$el.find(".divCommentItemText").first().text("Comment Deleted"),this.$el.find(".divCommentItemVoteButtons").first().children().hide(),this.$el.find(".divCommentItemUsername").first().hide(),this.$el.find(".divCommentItemPoints").first().hide(),this.$el.find(".divCommentItemEdit").first().hide(),this.$el.find(".divCommentItemReply").first().hide(),this.$el.find(".divCommentItemDelete").first().hide()},vote:function(e,t){e.stopPropagation();var i=this,a={storyboard_id:app.comments.view.main.storyboard_id,comment_id:this.data.comment_id,direction:t};app.server.voteOnComment(a,function(e,t){e===!0&&i.$el.find(".divCommentItemPoints").first().text("Points "+t.points)})},clickedUpvote:function(e){this.setDownvote(!0),this.$el.find(".divButtonUpvote").first().hasClass("divButtonUpvoteHighlight")===!1?(this.vote(e,"u"),this.setUpvote()):(this.vote(e,"n"),this.setUpvote(!0))},clickedDownvote:function(e){this.setUpvote(!0),this.$el.find(".divButtonDownvote").first().hasClass("divButtonDownvoteHighlight")===!1?(this.vote(e,"d"),this.setDownvote()):(this.vote(e,"n"),this.setDownvote(!0))},setUpvote:function(e){e===!0?this.$el.find(".divButtonUpvote").first().removeClass("divButtonUpvoteHighlight"):this.$el.find(".divButtonUpvote").first().addClass("divButtonUpvoteHighlight")},setDownvote:function(e){e===!0?this.$el.find(".divButtonDownvote").first().removeClass("divButtonDownvoteHighlight"):this.$el.find(".divButtonDownvote").first().addClass("divButtonDownvoteHighlight")}});var app=app||{};app.dialog={},app.dialog.view={},app.dialog.view.OkCancel=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogOkCancel").html()),events:{"click #buttonDialogOk":"ok","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e,t){this.data=e,this.callback=t,this.render()},render:function(){return this.$el.html(this.template(this.data)),this},ok:function(){this.callback(!0)}}),app.dialog.view.FromUrl=Backbone.View.extend({template:_.template($("#templateDialogFromUrl").html()),events:{"click #buttonDialogOk":"ok","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e,t){this.setElement(e),this.callback=t,this.render()},render:function(){return this.$el.html(this.template()),$("#inputFromUrl").focus(),this},ok:function(){var e=this.$el.find("#inputFromUrl").val();app.util.stringStartsWithHttpOrHttps(e)!==!1&&app.util.stringEndsWithImageExtension(e)!==!1&&this.callback(!0,e)}}),app.dialog.view.PictureGallery=app.base.view.GalleryBase.extend({el:"#divGalleryContainer",template:_.template($("#templateDialogPictureGallery").html()),initialize:function(e){this.callback=e,this.render(),app.base.view.GalleryBase.prototype.initialize.apply(this),this.delegateEvents(_.extend(_.clone(this.events),{"click .divItemImage":"selectImage","click #buttonDialogCancel":function(){this.callback(!1)}}))},render:function(){return this.$el.html(this.template()),this},selectImage:function(e){var t=$(e.target).closest(".divGalleryItem").find("img")[0].src.replace("thumb_",""),i=t.split("/"),a=i[i.length-1],n=a.split("?")[0];this.callback(!0,n)}}),app.dialog.view.ViewPicture=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogViewPicture").html()),events:{"click #divDialogViewPicture":function(){this.callback()},"click #imgViewPicture":function(){this.callback()}},initialize:function(e,t){this.pictureUrl=e,this.callback=t,this.render()},render:function(){return this.$el.html(this.template()),this.$el.find("#imgViewPicture").attr("src",this.pictureUrl),this}}),app.dialog.view.CreateStoryboard=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogCreateStoryboard").html()),events:{"click #buttonDialogOk":"ok","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e){this.callback=e,this.render()},render:function(){this.$el.html(this.template());for(var e=0;e<app.data.categories.length;e++)this.$el.find("#selectCategory").append("<option value='"+app.data.categories[e]+"'>"+app.data.categories[e]+"</option>");var t=!1;return(-1!==navigator.userAgent.indexOf("MSIE")||navigator.appVersion.indexOf("Trident/")>0)&&(t=!0),t===!1&&($("#selectCategory").on("mousedown",function(){this.options.length>5&&(this.size=8)}),$("#selectCategory").on("change blur",function(){this.size=0})),this},ok:function(){var e=this.$el.find("#inputTitle").val().trim();if(0===e.length)return void app.util.showToast("Error","You need to enter a Title");if(e.length>70)return void app.util.showToast("Error","Title is 70 character limit.  You have "+e.length+" characters");var t={title:e,category:$("#selectCategory option:selected").text(),type:$("#selectFirstScene").val(),is_private:$("#checkboxPrivate").prop("checked"),allow_comments:$("#checkboxAllowComments").prop("checked")};this.callback(!0,t)}}),app.dialog.view.StoryboardFullScreen=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogStoryboardFullScreen").html()),events:{"click #divCloseButton":"close"},initialize:function(e,t){var i=this;this.data=e,this.callback=t,this.render(),setTimeout(function(){for(var e=i.$el.find(".divSceneItem"),t=0;t<e.length;t++){var a=$(e[t]).data("type");"canvastext"!==a&&"textcanvas"!==a||e[t].offsetHeight<=app.data.sceneWidthHalf&&($(e[t]).css({height:e[t].offsetWidth/2}),$(e[t]).children().not("div").wrapAll("<div class='divCenterSceneVertical'></div>").wrapAll("<div class='divCenterSceneVerticalInner'></div>"))}},0)},render:function(){this.$el.html(this.template({title:this.data.title,username:this.data.username,category:this.data.category})),this.$el.find("#divContent").append($("<div class='divSceneGap'></div>"));for(var e=0;e<this.data.scenes.length;e++){var t="<div class='divSceneItem' data-type='"+this.data.scenes[e].type+"'>",i=this.data.scenes[e].canvas_data_svg;null!==i&&i.length>0&&(i=i.replace(app.data.regexImageProxy,app.data.serverHost+"/image-proxy-public/"+this.data.user_id),t+="canvastext"===this.data.scenes[e].type?"<div class='divImageLeft'>"+i+"</div>":"textcanvas"===this.data.scenes[e].type?"<div class='divImageRight'>"+i+"</div>":"<div class='divImageCenter'>"+i+"</div>");var a=this.data.scenes[e].text;if(null!==a&&a.length>0){var n=a.replace(app.data.regexHashtag,"<a class='aSceneHashtag'>$&</a>");n=n.replace(app.data.regexUrl,"<a class='aSceneUrl'>$&</a>"),t+=n}t+="</div>",this.$el.find("#divContent").append($(t)),this.$el.find("#divContent").append($("<div class='divSceneGap'></div>"))}return this},close:function(){this.callback(!1)}}),app.dialog.view.CanvasChoosePicture=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogCanvasChoosePicture").html()),events:{"click #buttonDialogAddBackgroundPicture":"backgroundPicture","click #buttonDialogAddBackgroundColor":"backgroundColor","click #buttonDialogRemoveBackground":"removeBackground","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e){this.callback=e,this.render()},render:function(){return this.$el.html(this.template()),this},backgroundPicture:function(){this.callback(!0,"addBackgroundPicture")},backgroundColor:function(){this.callback(!0,"addBackgroundColor")},removeBackground:function(){this.callback(!0,"removeBackground")}}),app.dialog.view.ScenePatterns=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogScenePattern").html()),events:{"click .divImage":"selectPattern","click #buttonDialogRemovePattern":function(){this.callback(!0,"removePattern")},"click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e,t){this.backgroundColor=e,this.callback=t,this.render()},render:function(){this.$el.html(this.template());app.util.preventWindowScroll(this.$el.find("#divPatterns"));for(var e=0;e<app.data.patternImages.length;e++){var t=$("<div class='divImage' data-index='"+e+"'></div>");t.css({"background-image":"url(../res/patterns/"+app.data.patternImages[e]+")","background-color":this.backgroundColor}),this.$el.find("#divPatterns").append(t)}return this},selectPattern:function(e){var t=$(e.target).data("index"),i=app.data.patternImages[t];this.callback(!0,i)}}),app.dialog.view.PositionBackgroundImage=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogPositionBackgroundImage").html()),events:{"click #buttonDialogOk":"ok","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e,t,i){this.isFullWidth=e,this.imageName=t,this.callback=i,this.mouseIsDown=!1,this.originalImgWidth=0,this.originalImgHeight=0,this.render()},render:function(){this.$el.html(this.template());var e=this;this.$el.find("#divPicture").css({height:app.data.sceneHeight,width:this.isFullWidth?app.data.sceneWidth:app.data.sceneWidthHalf}),this.$el.find("#imgPicture").attr("src","../image-proxy/"+this.imageName),this.$el.find("#imgPicture").imagesLoaded(function(){try{e.originalImgWidth=e.$el.find("#imgPicture")[0].offsetWidth,e.originalImgHeight=e.$el.find("#imgPicture")[0].offsetHeight}catch(t){}}),this.$el.find("#inputRange").rangeslider({polyfill:!1,rangeClass:"rangeMain",fillClass:"rangeFill",handleClass:"rangeHandle",onSlide:function(t,i){e.$el.find("#imgPicture").css({width:e.originalImgWidth*(i/100),height:e.originalImgHeight*(i/100)})}});var t,i,a,n;this.$el.find("#imgPicture").on("touchstart mousedown",function(o){o.stopPropagation(),o.preventDefault(),e.mouseIsDown=!0,t=o.pageX,i=o.pageY,a=e.$el.find("#imgPicture")[0].offsetLeft,n=e.$el.find("#imgPicture")[0].offsetTop}),this.$el.find("#imgPicture").on("touchmove mousemove",function(o){o.stopPropagation(),o.preventDefault(),e.mouseIsDown===!0&&$(this).css({left:a+(o.pageX-t),top:n+(o.pageY-i)})}),this.$el.on("touchend mouseup",function(t){e.mouseIsDown=!1})},ok:function(){this.$el.off("touchend mouseup");var e=this.$el.find("#divPicture")[0].offsetLeft-(this.isFullWidth?app.data.sceneWidth/2:app.data.sceneWidthHalf/2),t=this.$el.find("#divPicture")[0].offsetTop-app.data.sceneHeight/2,i=this.$el.find("#imgPicture")[0].offsetLeft,a=this.$el.find("#imgPicture")[0].offsetTop,n={left:i-e,top:a-t,width:this.$el.find("#imgPicture")[0].offsetWidth,height:this.$el.find("#imgPicture")[0].offsetHeight};this.callback(!0,n)}}),app.dialog.view.Emoji=Backbone.View.extend({el:"#divGalleryContainer",template:_.template($("#templateDialogEmoji").html()),events:{"click .divImageItem":"pickImage","click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e){this.callback=e,this.render()},render:function(){var e=this;this.$el.html(this.template());for(var t=e.$el.find("#divImages"),i=0;i<app.data.emojiImages.length;i++)$(t).append("<div class='divImageItem' data-id='"+app.data.emojiImages[i]+"'></div>")},pickImage:function(e){this.callback(!0,"../res/emoji/"+$(e.currentTarget).data("id"))}}),app.dialog.view.ImageStoryboardLink=Backbone.View.extend({el:"#divDialogContainer",template:_.template($("#templateDialogImageStoryboardLink").html()),events:{"click #buttonDialogDelete":function(){this.callback(!0)},"click #buttonDialogCancel":function(){this.callback(!1)}},initialize:function(e,t){this.storyboards=e,this.callback=t,this.render()},render:function(){this.$el.html(this.template());for(var e=0;e<this.storyboards.length;e++)this.$el.find("#ulStoryboards").append($("<li>"+this.storyboards[e]+"</li>"))}});var app=app||{};app.editStoryboard={},app.editStoryboard.view={},app.editStoryboard.view.Main=Backbone.View.extend({el:"#divEditStoryboard",events:{"click #buttonBackToStoryboards":function(){location.href="../account/storyboards"},"click #buttonAddScenePattern":"setScenePattern","click #buttonAddSceneCanvasText":function(){this.addScene("canvastext")},"click #buttonAddSceneTextCanvas":function(){this.addScene("textcanvas")},"click #buttonAddSceneText":function(){this.addScene("text")},"click #buttonAddSceneCanvas":function(){this.addScene("canvas")},"focusout #inputEditStoryboardTitle":"saveStoryboardDetails","change #selectEditStoryboardCategory":"saveStoryboardDetails","change #checkboxPrivate":"saveStoryboardDetails","change #checkboxAllowComments":"saveStoryboardDetails"},initialize:function(){var e=this;this.lastStoryboardDetailsData=null;for(var t=0;t<app.data.categories.length;t++)this.$el.find("#selectEditStoryboardCategory").append("<option value='"+app.data.categories[t]+"'>"+app.data.categories[t]+"</option>");app.server.getStoryboard(e.$el.data("storyboard_id"),function(t,i){if(t===!0){if(void 0===i&&(location.href="../account/storyboards"),e.$el.find("#inputEditStoryboardTitle").val(i.title),e.$el.find("#selectEditStoryboardCategory").val(i.category||"Uncategorized"),e.$el.find("#checkboxPrivate").prop("checked","1"===i.is_private),e.$el.find("#checkboxAllowComments").prop("checked","1"===i.allow_comments),e.scene_pattern=i.scene_pattern,i.scenes.length>0){for(var a=app.util.sortArray(i.scenes,"storyboard_index"),n=0;n<a.length;n++){var o=new app.items.view.SceneItem(a[n]);e.$el.find("#divScenes").append(o.el)}e.refreshSceneIndicies()}e.$el.find("#inputColorPickerSceneBackground").spectrum({showPalette:!0,showAlpha:!0,color:i.scene_color,clickoutFiresChange:!1,show:function(){$("body > .sp-container").find(".sp-choose").on("click.myChooseClick",function(){e.setSceneBackgroundColor($("#inputColorPickerSceneBackground").spectrum("get").toHexString())})},hide:function(){$("body > .sp-container").find(".sp-choose").off("click.myChooseClick"),e.saveStoryboardDetails()},move:function(t){e.setSceneBackgroundColor(t.toHexString())}}),e.$el.find(".divInputContainer").css({"max-width":"auto",border:"none"}),e.setSceneBackgroundColor(i.scene_color),void 0!==e.scene_pattern&&null!==e.scene_pattern&&0!==e.scene_pattern.length&&e.$el.find(".divInner").css({"background-image":"url(../res/patterns/"+e.scene_pattern+")"})}})},addScene:function(e){var t=this,i=t.$el.find("#divScenes").children().length,a={storyboard_id:this.$el.data("storyboard_id"),storyboard_index:i,type:e};app.server.createScene(a,function(a,n){t.removeEditorInstances(),t.hideCanvasControls(),t.$el.find("#divScenes").append(new app.items.view.SceneItem({scene_id:n,type:e,storyboard_index:i}).el),t.refreshSceneIndicies(),t.$el.find(".divStoryboardSceneItemBasic")[i].scrollIntoView()})},removeScene:function(e){var t=this,i={storyboard_id:this.$el.data("storyboard_id"),storyboard_index:e.data.storyboard_index};app.server.deleteScene(i,function(i){t.removeEditorInstances(),t.hideCanvasControls(),e.remove(),t.refreshSceneIndicies()})},moveSceneUp:function(e){this.removeEditorInstances(),this.hideCanvasControls();var t=e.prev(".divStoryboardSceneItem");0!==t.length&&(e.insertBefore(t),this.refreshSceneIndicies(),this.saveSceneIndicies())},moveSceneDown:function(e){this.removeEditorInstances(),this.hideCanvasControls();var t=e.next(".divStoryboardSceneItem");0!==t.length&&(e.insertAfter(t),this.refreshSceneIndicies(),this.saveSceneIndicies())},refreshSceneIndicies:function(){this.$el.find("#divScenes").children().each(function(e){var t=$(this).find(".divStoryboardSceneItemBasic").data("type"),i="Scene "+(e+1);switch(t){case"canvastext":i+=" - Canvas/Text";break;case"textcanvas":i+=" - Text/Canvas";break;case"text":i+=" - Text Only";break;case"canvas":i+=" - Canvas Only"}$(this).find(".labelSceneIndex").text(i),$(this).find(".divStoryboardSceneItemBasic").attr("data-storyboard_index",e),$(this).find(".canvasMain").attr("id","canvas"+e),$(this).find(".divActualText").attr("id","editor"+e),$(this).find(".divCanvasControls").attr("id","divCanvasControls"+e),$(this).find(".divTextControls").attr("id","divTextControls"+e),$(this).find(".inputCanvasColorPicker").attr("id","inputCanvasColorPicker"+e),$(this).find(".inputTextColorPicker").attr("id","inputTextColorPicker"+e),$(this).find(".editorTop").attr("id","divEditorTop"+e),$(this).find(".editorBottom").attr("id","divEditorBottom"+e)})},saveSceneIndicies:function(){var e=[];this.$el.find(".divStoryboardSceneItemBasic").each(function(t){e.push({scene_id:$(this).data("scene_id"),storyboard_index:t})}),app.server.updateSceneIndicies(e,function(e){})},saveStoryboardDetails:function(){var e=this.$el.find("#inputEditStoryboardTitle").val().trim();if(0===e.length)return void app.util.showToast("Error","You need to enter a Title for your Storyboard");if(e.length>70)return void app.util.showToast("Error","Storyboard title is 70 character limit.  You have "+e.length+" characters");var t={storyboard_id:this.$el.data("storyboard_id"),title:e,category:this.$el.find("#selectEditStoryboardCategory option:selected").text(),is_private:this.$el.find("#checkboxPrivate").prop("checked"),allow_comments:this.$el.find("#checkboxAllowComments").prop("checked"),scene_color:this.$el.find("#inputColorPickerSceneBackground").spectrum("get").toHexString(),scene_pattern:this.scene_pattern};_.isEqual(this.lastStoryboardDetailsData,t)===!1&&app.server.updateStoryboardDetails(t,function(e){}),this.lastStoryboardDetailsData=t},setSceneBackgroundColor:function(e){this.$el.find(".divInner").css({"background-color":e})},setScenePattern:function(){var e=this;$("#divDialogContainer").show();var t=this.$el.find("#inputColorPickerSceneBackground").spectrum("get").toHexString();new app.dialog.view.ScenePatterns(t,function(t,i){app.util.hideDialog(),t===!0&&("removePattern"===i?(e.$el.find(".divInner").css({"background-image":"none"}),e.scene_pattern=null):(e.$el.find(".divInner").css({"background-image":"url(../res/patterns/"+i+")"}),e.scene_pattern=i),e.saveStoryboardDetails())})},removeEditorInstances:function(){this.$el.find(".divTextControls").hide();for(name in CKEDITOR.instances)CKEDITOR.instances[name].destroy(!0)},hideCanvasControls:function(){this.$el.find(".divCanvasControls").hide()}});var app=app||{};app.help={},app.help.view={},app.help.view.Main=Backbone.View.extend({el:"#divHelp",events:{},initialize:function(){}});var app=app||{};app.search={},app.search.view={},app.search.view.Main=Backbone.View.extend({el:"#divSearch",events:{"click #buttonSearchGo":"search","click #checkboxSearchTitles":"checkboxClicked","click #checkboxSearchUsernames":"checkboxClicked","click #checkboxSearchText":"checkboxClicked","click .divPaginationItem":"paginationItemClicked"},initialize:function(){var e=0;for(this.currentPage=1,$("html").css({"overflow-y":"scroll"}),$("#selectSearchCategory").append("<option value='All Categories'>All Categories</option>"),e=0;e<app.data.categories.length;e++)$("#selectSearchCategory").append("<option value='"+app.data.categories[e]+"'>"+app.data.categories[e]+"</option>");for(e=0;e<app.data.searchSortBy.length;e++)$("#selectSearchSortBy").append("<option value='"+app.data.searchSortBy[e]+"'>"+app.data.searchSortBy[e]+"</option>");this.search()},search:function(){var e=this,t={searchTerm:$("#inputSearchTerm").val(),category:$("#selectSearchCategory option:selected").text(),sortBy:$("#selectSearchSortBy option:selected").text(),searchTitles:$("#checkboxSearchTitles").prop("checked"),searchUsernames:$("#checkboxSearchUsernames").prop("checked"),searchText:$("#checkboxSearchText").prop("checked"),selectedPage:this.currentPage};this.$el.find("#divSearchResults").hide(),this.$el.find("#divNoResults").hide(),this.$el.find("#divLoading").show(),app.server.search(t,function(t,i){if(e.$el.find("#divSearchResults").empty(),e.$el.find("#divSearchResults").unbind(),t===!0)if(null===i||0===i.length||void 0===i.storyboards||null===i.storyboards||0===i.storyboards.length)e.$el.find("#divSearchResults").hide(),e.$el.find("#divLoading").hide(),e.$el.find("#divNoResults").show();else{var a=0;if(e.currentPage=i.selectedPage,void 0!==i.scenes&&null!==i.scenes&&i.scenes.length>0)for(a=0;a<i.storyboards.length;a++){i.storyboards[a].scenes=[];for(var n=0;n<i.scenes.length;n++)i.storyboards[a].storyboard_id===i.scenes[n].storyboard_id&&i.storyboards[a].scenes.push(i.scenes[n])}for(a=0;a<i.storyboards.length;a++)e.$el.find("#divSearchResults").append(new app.items.view.StoryboardItem("search",i.storyboards[a]).el);e.createPaginator(i.numStoryboards,i.itemsPerPage,i.selectedPage),e.$el.find("#divNoResults").hide(),e.$el.find("#divLoading").hide(),e.$el.find("#divSearchResults").show()}})},checkboxClicked:function(e){$("#checkboxSearchTitles").prop("checked",!1),$("#checkboxSearchUsernames").prop("checked",!1),$("#checkboxSearchText").prop("checked",!1),$(e.target).prop("checked",!0)},createPaginator:function(e,t,i){$("#divPaginationContainer").empty(),$("#divPaginationContainer").unbind();var a,n,o=Math.ceil(e/t);for(a=0;o>a;a++){n=a+1==i?"divPaginationItem selectedPage":"divPaginationItem";var s="<div class='"+n+"' data-page='"+(a+1)+"'><label>"+(a+1)+"</label></div>";$("#divPaginationContainer").append($(s))}},paginationItemClicked:function(e){this.currentPage=$(e.target).data("page"),this.search()}});var app=app||{};!function(){var e=window.location.pathname;new app.main.view.Main,app.editStoryboard.view.main=null,app.account.view.storyboards=null,app.comments.view.main=null,app.util.stringStartsWith(e,"/search")?new app.search.view.Main:app.util.stringStartsWith(e,"/account/storyboards")?app.account.view.storyboards=new app.account.view.Storyboards:app.util.stringStartsWith(e,"/account/gallery")?new app.account.view.Gallery:app.util.stringStartsWith(e,"/account/social")||(app.util.stringStartsWith(e,"/account/settings")?new app.account.view.Settings:app.util.stringStartsWith(e,"/account/change-password")?new app.account.view.ChangePassword:app.util.stringStartsWith(e,"/edit-storyboard")?app.editStoryboard.view.main=new app.editStoryboard.view.Main:app.util.stringStartsWith(e,"/help")?new app.help.view.Main:app.util.stringStartsWith(e,"/comments")&&(app.comments.view.main=new app.comments.view.Main));
}();